name: Build OTA Package

on:
  workflow_dispatch:
    inputs:
      use_upx:
        description: 'build with upx'
        required: false
        type: boolean
        default: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-ota:
    name: Build OTA Package
    runs-on: ubuntu-24.04-arm
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œç”¨äºŽ git commit hash
      
      - name: Read VERSION
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ ç‰ˆæœ¬å·: $VERSION"
      
      # ==================== å®‰è£… Rust å·¥å…·é“¾ ====================
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-musl
      
      # ==================== å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·é“¾ ====================
      - name: Install cross-compilation toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools
          musl-gcc --version
      
      # ==================== å®‰è£… UPX (å¯é€‰) ====================
      - name: Install UPX
        if: inputs.use_upx == true
        run: |
          sudo apt-get install -y upx-ucl
          upx --version
      
      # ==================== ç¼“å­˜ Rust ä¾èµ– ====================
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            backend/target/
          key: ${{ runner.os }}-musl-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-musl-cargo-
      
      # ==================== åŒæ­¥ç‰ˆæœ¬å· ====================
      - name: Sync version numbers
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "åŒæ­¥ç‰ˆæœ¬å·: $VERSION"
          
          # æ›´æ–° backend/Cargo.toml
          sed -i "s/^version = \"[^\"]*\"/version = \"$VERSION\"/" backend/Cargo.toml
          
          # æ›´æ–° frontend/package.json
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" frontend/package.json
          
          echo "âœ… ç‰ˆæœ¬å·åŒæ­¥å®Œæˆ"
      
      # ==================== æž„å»ºåŽç«¯ ====================
      - name: Build backend (aarch64-unknown-linux-musl)
        working-directory: backend
        run: |
          echo "ðŸ¦€ æž„å»ºåŽç«¯ (aarch64-unknown-linux-musl)..."
          
          # è®¾ç½®äº¤å‰ç¼–è¯‘çŽ¯å¢ƒå˜é‡
          export CC_AARCH64_UNKNOWN_LINUX_MUSL=musl-gcc
          export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER=musl-gcc
          export SQLITE3_STATIC=1
          export LIBSQLITE3_SYS_USE_PKG_CONFIG=0
          
          # æž„å»º
          cargo build --release --target aarch64-unknown-linux-musl
          
          BINARY_PATH="target/aarch64-unknown-linux-musl/release/udx710"
          
          echo "âœ… åŽç«¯æž„å»ºå®Œæˆï¼"
          ls -lh "$BINARY_PATH"
          file "$BINARY_PATH"
      
      # ==================== UPX åŽ‹ç¼© (å¯é€‰) ====================
      - name: Compress binary with UPX
        if: inputs.use_upx == true
        run: |
          BINARY_PATH="backend/target/aarch64-unknown-linux-musl/release/udx710"
          
          echo "ðŸ—œï¸  UPX åŽ‹ç¼©ä¸­..."
          BEFORE_SIZE=$(stat -c%s "$BINARY_PATH")
          
          upx --best --lzma "$BINARY_PATH"
          
          AFTER_SIZE=$(stat -c%s "$BINARY_PATH")
          RATIO=$(echo "scale=1; 100 - ($AFTER_SIZE * 100 / $BEFORE_SIZE)" | bc)
          
          echo "âœ… åŽ‹ç¼©å®Œæˆï¼èŠ‚çœ: ${RATIO}%"
          ls -lh "$BINARY_PATH"
      
      # ==================== è®¾ç½® Node.js çŽ¯å¢ƒ ====================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      # ==================== æž„å»ºå‰ç«¯ ====================
      - name: Build frontend
        working-directory: frontend
        run: |
          echo "ðŸŽ¨ æž„å»ºå‰ç«¯..."
          pnpm install --frozen-lockfile
          pnpm run build
          
          echo "âœ… å‰ç«¯æž„å»ºå®Œæˆï¼"
          ls -lh dist/
      
      # ==================== æ‰“åŒ… OTA ====================
      - name: Package OTA
        run: |
          echo "=========================================="
          echo "  ç”Ÿæˆ OTA æ›´æ–°åŒ…"
          echo "=========================================="
          echo ""
          
          VERSION="${{ steps.version.outputs.version }}"
          COMMIT=$(git rev-parse --short HEAD)
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          ARCH="aarch64-unknown-linux-musl"
          
          BINARY_PATH="backend/target/aarch64-unknown-linux-musl/release/udx710"
          FRONTEND_DIR="frontend/dist"
          
          # æ£€æŸ¥æž„å»ºäº§ç‰©
          if [ ! -f "$BINARY_PATH" ]; then
            echo "âŒ é”™è¯¯: åŽç«¯äºŒè¿›åˆ¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ ! -d "$FRONTEND_DIR" ]; then
            echo "âŒ é”™è¯¯: å‰ç«¯æž„å»ºäº§ç‰©ä¸å­˜åœ¨"
            exit 1
          fi
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          OTA_TMP=$(mktemp -d)
          
          echo "ðŸ“¦ ç‰ˆæœ¬: $VERSION"
          echo "ðŸ“ Commit: $COMMIT"
          echo "ðŸ• æž„å»ºæ—¶é—´: $BUILD_TIME"
          echo "ðŸ“ æž¶æž„: $ARCH"
          echo ""
          
          # å¤åˆ¶åŽç«¯äºŒè¿›åˆ¶
          echo "ðŸ“‹ å¤åˆ¶åŽç«¯äºŒè¿›åˆ¶..."
          cp "$BINARY_PATH" "$OTA_TMP/udx710"
          chmod 755 "$OTA_TMP/udx710"
          
          # è®¡ç®—äºŒè¿›åˆ¶ MD5 (Linux)
          BINARY_MD5=$(md5sum "$OTA_TMP/udx710" | cut -d' ' -f1)
          echo "   MD5: $BINARY_MD5"
          
          # å¤åˆ¶å‰ç«¯æ–‡ä»¶
          echo "ðŸ“‹ å¤åˆ¶å‰ç«¯æ–‡ä»¶..."
          mkdir -p "$OTA_TMP/www"
          cp -r "$FRONTEND_DIR"/* "$OTA_TMP/www/"
          
          # è®¡ç®—å‰ç«¯ MD5 (Linux)
          echo "ðŸ“‹ è®¡ç®—å‰ç«¯ MD5..."
          FRONTEND_MD5=$(find "$OTA_TMP/www" -type f -exec md5sum {} \; | cut -d' ' -f1 | sort | md5sum | cut -d' ' -f1)
          echo "   MD5: $FRONTEND_MD5"
          
          # ç”Ÿæˆ meta.json
          echo "ðŸ“‹ ç”Ÿæˆ meta.json..."
          cat > "$OTA_TMP/meta.json" << EOF
          {
              "version": "$VERSION",
              "commit": "$COMMIT",
              "build_time": "$BUILD_TIME",
              "binary_md5": "$BINARY_MD5",
              "frontend_md5": "$FRONTEND_MD5",
              "arch": "$ARCH"
          }
          EOF
          
          cat "$OTA_TMP/meta.json"
          echo ""
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p release
          
          # æ‰“åŒ…
          OTA_FILE="release/udx710-ota-${VERSION}.tar.gz"
          echo "ðŸ“¦ æ‰“åŒ… OTA æ›´æ–°åŒ…..."
          cd "$OTA_TMP"
          tar -czf "$GITHUB_WORKSPACE/$OTA_FILE" meta.json udx710 www
          cd "$GITHUB_WORKSPACE"
          
          # æ˜¾ç¤ºç»“æžœ
          echo ""
          echo "=========================================="
          echo "âœ… OTA æ›´æ–°åŒ…æ‰“åŒ…å®Œæˆï¼"
          echo "=========================================="
          echo ""
          echo "ðŸ“ è¾“å‡ºæ–‡ä»¶: $OTA_FILE"
          ls -lh "$OTA_FILE"
          echo ""
          echo "ðŸ“‹ åŒ…å†…å®¹:"
          tar -tzf "$OTA_FILE" | head -20
          echo ""
          
          # è®¡ç®—åŒ…çš„ MD5
          OTA_MD5=$(md5sum "$OTA_FILE" | cut -d' ' -f1)
          echo "ðŸ“ OTA åŒ… MD5: $OTA_MD5"
          echo ""
          
          # ä¿å­˜åˆ°è¾“å‡º
          echo "ota_file=$OTA_FILE" >> $GITHUB_OUTPUT
          echo "ota_md5=$OTA_MD5" >> $GITHUB_OUTPUT
        id: package
      
      # ==================== ä¸Šä¼  OTA åŒ…ä¸º Artifact ====================
      - name: Upload OTA package
        uses: actions/upload-artifact@v4
        with:
          name: udx710-ota-${{ steps.version.outputs.version }}
          path: release/udx710-ota-${{ steps.version.outputs.version }}.tar.gz
          retention-days: 90
          if-no-files-found: error
      
      # ==================== åˆ›å»º Release (å¯é€‰) ====================
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: release/udx710-ota-${{ steps.version.outputs.version }}.tar.gz
          body: |
            ## OTA æ›´æ–°åŒ…
            
            **ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}
            **Commit**: ${{ github.sha }}
            **æž„å»ºæ—¶é—´**: ${{ github.event.repository.updated_at }}
            
            ### å®‰è£…è¯´æ˜Ž
            
            ```bash
            # ä¸Šä¼  OTA åŒ…åˆ°è®¾å¤‡
            curl -X POST http://192.168.66.1:3000/api/ota/upload \
              -F "file=@udx710-ota-${{ steps.version.outputs.version }}.tar.gz"
            
            # å¼€å§‹ OTA æ›´æ–°
            curl -X POST http://192.168.66.1:3000/api/ota/update
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # ==================== æž„å»ºæ‘˜è¦ ====================
      - name: Build Summary
        run: |
          echo "## ðŸŽ‰ OTA åŒ…æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬ | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æž¶æž„ | aarch64-unknown-linux-musl |" >> $GITHUB_STEP_SUMMARY
          echo "| UPX åŽ‹ç¼© | ${{ inputs.use_upx }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ äº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.package.outputs.ota_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- MD5: \`${{ steps.package.outputs.ota_md5 }}\`" >> $GITHUB_STEP_SUMMARY

